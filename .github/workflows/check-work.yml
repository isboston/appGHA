name: Workflow notify

on:
  schedule:
    - cron: "30 6 * * *"
  workflow_dispatch:

jobs:
  check-failed-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Notify failed runs
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          WORKFLOWS: |
            appGHA|ci-oci.yml
            appGHA|test2.yml
            appGHA|check-wo.yml
            appGHA|tg_notify.yml
            appGHA2|test.yml
        run: |
          # Use associative arrays to track statuses and messages
          # Use associative arrays to track statuses and messages
            # Use associative arrays to track statuses and messages
            declare -A REPO_STATUS
            declare -A REPO_COUNT

            while IFS='|' read -r REPO WORKFLOW; do
            [[ -z "$REPO" || -z "$WORKFLOW" ]] && continue
            
            FULL_REPO="isboston/$REPO"
            API_URL="https://api.github.com/repos/$FULL_REPO/actions/workflows/$WORKFLOW/runs?per_page=30"
            
            RESPONSE="$(curl -s -H "Authorization: ***" "$API_URL")"
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»Ðµ workflow_runs Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð¸ ÑÑ‚Ð¾ Ð¼Ð°ÑÑÐ¸Ð²
            IS_ARRAY=$(echo "$RESPONSE" | jq -r '
                if (.workflow_runs | type) == "array" then "yes" else "no" end
            ' 2>/dev/null)

            if [[ "$IS_ARRAY" != "yes" ]]; then
                echo "Error or unexpected JSON from $FULL_REPO/$WORKFLOW:"
                echo "$RESPONSE"
                continue
            fi
            
            # Ð”Ð»Ñ Ð½Ð°Ð´Ñ‘Ð¶Ð½Ð¾ÑÑ‚Ð¸ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð±ÑŠÐµÐºÑ‚Ñ‹ Ð¸Ð· workflow_runs,
            # Ñƒ ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… ÐµÑÑ‚ÑŒ .created_at, .head_branch. Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÑ‘ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ð¾Ðµ.
            RUNS="$(echo "$RESPONSE" | jq --arg start "$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ)" '
                [
                .workflow_runs[]
                # ÐŸÐ¾Ð´ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²ÐºÐ°: Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð±ÑŠÐµÐºÑ‚Ñ‹
                | select(type == "object")
                # Ð—Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 24 Ñ‡Ð°ÑÐ°
                | select(.created_at >= $start)
                # Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ Ð²ÐµÑ‚ÐºÐ°Ð¼
                | select(.head_branch | test("^(main|release/.+|hotfix/.+|develop)$"))
                ]
            ')"

            # ÐŸÐ¾Ð´ÑÑ‡Ñ‘Ñ‚ Ñ„ÐµÐ¹Ð»Ð¾Ð² Ð¸ ÑƒÑÐ¿ÐµÑ…Ð¾Ð²
            FAIL_COUNT="$(echo "$RUNS" | jq '[.[] | select((.conclusion? // "failure") | test("failure|failed|error|startup_failure"))] | length')"
            SUCCESS_COUNT="$(echo "$RUNS" | jq '[.[] | select(.conclusion == "success")] | length')"

            if (( FAIL_COUNT > 0 )); then
                STATUS="âŒ"
            elif (( SUCCESS_COUNT > 0 )); then
                STATUS="âœ…"
            else
                # Ð•ÑÐ»Ð¸ Ð½Ð¸ Ñ„ÐµÐ¹Ð»Ð¾Ð², Ð½Ð¸ ÑƒÑÐ¿ÐµÑ…Ð¾Ð² â€” Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼
                continue
            fi

            # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÐ¸, Ð¿Ñ€Ð¸ ÑÑ‚Ð¾Ð¼ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ Ð±ÐµÐ· .name / .html_url / .head_branch,
            # Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Cannot index string with string "name".
            LINES="$(echo "$RUNS" | jq -r '
                [
                .[]
                | select(.name? and .html_url? and .head_branch?)
                | "\u25FB [\(.name[:29] + (if .name|length > 26 then "..." else "" end))](\(.html_url)) (\(.head_branch))"
                ] 
                | join("\n")
            ')"


            REPO_STATUS["$REPO"]+="$STATUS $WORKFLOW\n$LINES\n"
            (( REPO_COUNT["$REPO"] += (FAIL_COUNT>0 ? FAIL_COUNT : 0) ))
            done <<< "$WORKFLOWS"

            # ÐÐ³Ñ€ÐµÐ³Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚
            RESULT=""
            for REPO in "${!REPO_STATUS[@]}"; do
            COUNT="${REPO_COUNT[$REPO]}"
            HEADER="ðŸš€ REPO: $REPO"
            [[ "$COUNT" -gt 0 ]] && HEADER="âŒ $COUNT FAILED | 24h | $HEADER"
            RESULT+="$HEADER\n${REPO_STATUS[$REPO]}\n"
            done

            # ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð² Telegram, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ñ‡Ñ‚Ð¾
            if [[ -n "$RESULT" ]]; then
            RESULT_ESCAPED="${RESULT//\"/\\\"}"
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
                -H "Content-Type: application/json" \
                -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\",
                    \"text\": \"$RESULT_ESCAPED\",
                    \"parse_mode\": \"Markdown\",
                    \"disable_web_page_preview\": true}"
            fi

