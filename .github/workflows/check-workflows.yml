name: Check Workflows

on:
  schedule:
    - cron: "5 0 * * *"
  workflow_dispatch:

jobs:
  check-build-results:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ workflow runs Ğ·Ğ° Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 24 Ñ‡Ğ°ÑĞ°
        run: |
          # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´: Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ 24 Ñ‡Ğ°ÑĞ° Ğ¾Ñ‚ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚Ğ°
          START_TIME=$(date -u -d "24 hours ago" +"%Y-%m-%dT%H:%M:%SZ")
          END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "Ğ—Ğ°Ğ¿Ñ€Ğ°ÑˆĞ¸Ğ²Ğ°ĞµĞ¼ workflow runs Ñ $START_TIME Ğ¿Ğ¾ $END_TIME"

          # Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ñ… 100 Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¾Ğ² (Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ)
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" | \
            jq --arg start "$START_TIME" --arg end "$END_TIME" \
            '[.workflow_runs[] | select(.created_at >= $start and .created_at <= $end)]' > workflow_runs.json

          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ID Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ workflow run
          CURRENT_RUN_ID="${{ github.run_id }}"
          echo "Ğ˜ÑĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ workflow run Ñ ID $CURRENT_RUN_ID"

          # Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚, Ğ¸ÑĞºĞ»ÑÑ‡Ğ°Ñ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ workflow
          jq --arg current_run_id "$CURRENT_RUN_ID" '[.[] | select(.id != ($current_run_id | tonumber))]' workflow_runs.json > filtered_workflow_runs.json

          echo "ĞÑ‚Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:"
          cat filtered_workflow_runs.json

          # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ JSON Ñ Ğ½ÑƒĞ¶Ğ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑĞ¼Ğ¸ Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¾Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° (ĞµÑĞ»Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑ Ğ¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚, ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ·Ğ° Ğ½ĞµÑƒĞ´Ğ°Ñ‡Ğ½Ñ‹Ğ¹)
          jq '[.[] | {name: .name, branch: .head_branch, html_url: .html_url, status: (.conclusion // "failure"), triggered_by: (.triggering_actor.login // "unknown"), created_at: .created_at}]' filtered_workflow_runs.json > merged_results.json
          echo "Ğ˜Ñ‚Ğ¾Ğ³Ğ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ:"
          cat merged_results.json

      - name: ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ² Telegram, ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -s merged_results.json ] || [ "$(jq 'length' merged_results.json)" -eq 0 ]; then
            echo "Ğ—Ğ° ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´ Ğ½ĞµÑ‚ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ñ… ÑĞ±Ğ¾Ñ€Ğ¾Ğº."
            exit 0
          fi

          TOTAL=$(jq 'length' merged_results.json)
          LAST_RUN_ID=$(jq '.[0].id' merged_results.json)
          echo "ID Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ³Ğ¾ ÑĞºÑˆĞµĞ½Ğ°: $LAST_RUN_ID"

          # Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ÑƒĞµĞ¼ Ğ½ĞµÑƒĞ´Ğ°Ñ‡Ğ½Ñ‹Ğµ ÑĞ±Ğ¾Ñ€ĞºĞ¸
          FAILURES=$(jq '[.[] | select((.status == "failure" or .status == "failed" or .status == "error" or .status == "startup_failure") and .status != "in_progress")]' merged_results.json)
          FAIL_COUNT=$(echo "$FAILURES" | jq 'length')
          
          MESSAGE="ğŸ•’ Last 24h | ğŸ“Š Workflows: $TOTAL | âŒ *Failed: $FAIL_COUNT*\n"

          if [ "$FAIL_COUNT" -eq 0 ]; then
            exit 0
          else
            FAIL_LIST=$(echo "$FAILURES" | jq -r $'
              map(
                "ğŸ”¹ [\(.name | if length > 20 then .[0:20] + \"...\" else . end)](\(.html_url // \"ĞĞµÑ‚ ÑÑÑ‹Ğ»ĞºĞ¸\")) | ğŸ“Œ \(.branch // \"ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ²ĞµÑ‚ĞºĞ°\") | ğŸ‘¤ \(.triggered_by // \"ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹\") | â³ \(
                  (.created_at | fromdateiso8601) as $created |
                  (now - $created) as $diff |
                  if $diff < 3600 then
                    ($diff / 60 | floor | tostring + \"m ago\")
                  else
                    ($diff / 3600 | floor | tostring + \"h ago\")
                  end
                )"
              ) | join("\n")
            ')
            MESSAGE+="$FAIL_LIST"
          fi

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\", \"disable_web_page_preview\": true}"

