name: Check Workflows

on:
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:

jobs:
  check-failed-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Notify failed runs
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          FAILURES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" | 
            jq --arg start "$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ)" --arg cur "${{ github.run_id }}" '
            [ .workflow_runs[] | select(.created_at >= $start and .id != ($cur | tonumber)) 
              | select((.conclusion? // "failure") | test("failure|failed|error|startup_failure"))
              | select(.head_branch | test("^(main|release/.+|hotfix/.+|develop)$")) ]')

          [[ $(echo "$FAILURES" | jq 'length') -eq 0 ]] && exit 0

          MESSAGE=$(printf "üïí 24h in %s: ‚ùå *%s FAILED*\n%s" \
          "${{ github.repository }}" "$(jq -r '
            # –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–∞ n —Ä–∞–∑ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã)
            def repeat(s; n): if n <= 0 then "" else s + repeat(s; n - 1) end;

            # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∏–º–µ–Ω–∏ (–æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 25 —Å–∏–º–≤–æ–ª–æ–≤)
            . as $root | 
            ($root | map(.name | length) | max) as $max_len | 
            ($max_len | if . > 25 then 25 else . end) as $fixed_width |

            # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
            map(
              "üîπ [\(
                  if (.name | length) > $fixed_width 
                  then (.name[:($fixed_width - 3)] + "...")
                  else .name
                  end
                )](\(.html_url))" + repeat("\u00A0"; $fixed_width - (.name | length)) + " | üìå \(.head_branch)"
            )
            | join("\n")
          ' <<< "$FAILURES")")


          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\", \"disable_web_page_preview\": true}"
