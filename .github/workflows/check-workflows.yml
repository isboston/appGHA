name: Check Workflows

on:
  schedule:
    - cron: "5 0 * * *"
  workflow_dispatch:

jobs:
  check-build-results:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ workflow runs Ð·Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 24 Ñ‡Ð°ÑÐ°
        run: |
          # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¿ÐµÑ€Ð¸Ð¾Ð´: Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 24 Ñ‡Ð°ÑÐ° Ð¾Ñ‚ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð°
          START_TIME=$(date -u -d "24 hours ago" +"%Y-%m-%dT%H:%M:%SZ")
          END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "Ð—Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°ÐµÐ¼ workflow runs Ñ $START_TIME Ð¿Ð¾ $END_TIME"

          # Ð—Ð°Ð¿Ñ€Ð¾Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… 100 Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð² (Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¼Ð¾Ð¶Ð½Ð¾ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð¾ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ)
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" | \
            jq --arg start "$START_TIME" --arg end "$END_TIME" \
            '[.workflow_runs[] | select(.created_at >= $start and .created_at <= $end)]' > workflow_runs.json

          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ID Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ workflow run
          CURRENT_RUN_ID="${{ github.run_id }}"
          echo "Ð˜ÑÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ workflow run Ñ ID $CURRENT_RUN_ID"

          # Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚, Ð¸ÑÐºÐ»ÑŽÑ‡Ð°Ñ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ workflow
          jq --arg current_run_id "$CURRENT_RUN_ID" '[.[] | select(.id != ($current_run_id | tonumber))]' workflow_runs.json > filtered_workflow_runs.json

          echo "ÐžÑ‚Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ:"
          cat filtered_workflow_runs.json

          # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ JSON Ñ Ð½ÑƒÐ¶Ð½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð»ÑÐ¼Ð¸ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° (ÐµÑÐ»Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚, ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ð·Ð° Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ð¹)
          jq '[.[] | {name: .name, branch: .head_branch, html_url: .html_url, status: (.conclusion // "failure"), triggered_by: (.triggering_actor.login // "unknown"), created_at: .created_at}]' filtered_workflow_runs.json > merged_results.json
          echo "Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ:"
          cat merged_results.json

      - name: ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð² Telegram, ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -s merged_results.json ] || [ "$(jq 'length' merged_results.json)" -eq 0 ]; then
            exit 0
          fi

          TOTAL=$(jq 'length' merged_results.json)
          LAST_RUN_ID=$(jq '.[0].id' merged_results.json)

          # Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÐ¼ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸
          FAILURES=$(jq '[.[] | select((.status == "failure" or .status == "failed" or .status == "error" or .status == "startup_failure") and .status != "in_progress")]' merged_results.json)
          FAIL_COUNT=$(echo "$FAILURES" | jq 'length')

          MESSAGE="ðŸ•’ Last 24h | ðŸ“Š Workflows: $TOTAL | âŒ *Failed: $FAIL_COUNT*\n"

          if [ "$FAIL_COUNT" -eq 0 ]; then
            exit 0
          else
            FAIL_LIST=$(echo "$FAILURES" | jq -r $'
              map(
                "ðŸ”¹ [\(.name | if length > 25 then .[0:25] + \"...\" else . end)](\(.html_url)) | ðŸ“Œ \(.branch)"
              ) | join("\n")
            ')
            MESSAGE+="$FAIL_LIST"
          fi

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\", \"disable_web_page_preview\": true}"

