name: Check Workflows

on:
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:

jobs:
  check-failed-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Notify failed runs
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          FAILURES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" | 
            jq --arg start "$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ)" --arg cur "${{ github.run_id }}" '
            [ .workflow_runs[] | select(.created_at >= $start and .id != ($cur | tonumber)) 
              | select((.conclusion? // "failure") | test("failure|failed|error|startup_failure"))
              | select(.head_branch | test("^(main|release/.+|hotfix/.+|develop)$")) ]')

          [[ $(echo "$FAILURES" | jq 'length') -eq 0 ]] && exit 0

          MESSAGE=$(printf "üïí 24h in %s: ‚ùå *%s FAILED*\n%s" \
          "${{ github.repository }}" "$(jq 'length' <<< "$FAILURES")" \
          "$(jq -r '
            # –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ –¥–ª–∏–Ω—ã –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫
            . as $root |
            ($root | map(.name | length) | max) as $name_max |
            ($root | map(.head_branch | length) | max) as $branch_max |
            # –î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –º–æ–∂–Ω–æ –∑–∞–¥–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ —à–∏—Ä–∏–Ω–µ –∏–º–µ–Ω–∏ (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
            ($name_max | if . > 30 then 30 else . end) as $fixed_name_width |
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –∑–∞–ø–∏—Å—å —Å –ø–æ–º–æ—â—å—é sprintf:
            map(
              # –§–æ—Ä–º–∞—Ç:
              # %-*s - –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ª–µ–≤–æ–º—É –∫—Ä–∞—é –≤ –ø–æ–ª–µ –∑–∞–¥–∞–Ω–Ω–æ–π —à–∏—Ä–∏–Ω—ã
              # %*s  - –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –ø—Ä–∞–≤–æ–º—É –∫—Ä–∞—é
              @sprintf("üîπ [%-*s](%s) | üìå %*s",
                $fixed_name_width,
                (.name | if length > $fixed_name_width then .[:($fixed_name_width - 3)] + "..." else . end),
                .html_url,
                $branch_max,
                .head_branch
              )
            )
            | join("\n")
          ' <<< "$FAILURES")")

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\", \"disable_web_page_preview\": true}"

