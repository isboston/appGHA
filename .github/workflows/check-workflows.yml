name: Check Workflows

on:
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:

jobs:
  check-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Notify failed runs
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Get time (last 24h)
          START_TIME=$(date -u -d "24 hours ago" +%Y-%m-%dT%H:%M:%SZ)

          # Fetch runs (last 100)
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100")

          FAILURES=$(echo "$RESPONSE" | jq --arg start "$START_TIME" --arg cur "${{ github.run_id }}" '
            [ .workflow_runs[]
              | select(.created_at >= $start and .id != ($cur | tonumber))
              | select((.conclusion? // "failure") | test("failure|failed|error|startup_failure"))
            ]
          ')

          FAIL_COUNT=$(echo "$FAILURES" | jq 'length')
          [ "$FAIL_COUNT" -eq 0 ] && exit 0

          MESSAGE="ðŸ•’ Last 24h | ðŸ“Š Workflows: $TOTAL | âŒ *Failed: $FAIL_COUNT*\n"
          MESSAGE+=$(echo "$FAILURES" | jq -r '
            map("ðŸ”¹ [\(.name[:25] + (if .name | length > 25 then "..." else "" end))](\(.html_url)) | ðŸ“Œ \(.head_branch)") | join("\n")'
          )

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\", \"disable_web_page_preview\": true}"

