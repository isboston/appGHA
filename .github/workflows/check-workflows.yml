name: Check Workflows

on:
  schedule:
    - cron: "55 6 * * *"
  workflow_dispatch:

jobs:
  check-failed-workflows:
    runs-on: ubuntu-latest
    steps:
    - name: Notify failed runs
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        FAILURES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" | 
          jq --arg start "$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ)" --arg cur "${{ github.run_id }}" '
          [ .workflow_runs[] 
            | select(.created_at >= $start and .id != ($cur | tonumber)) 
            | select((.conclusion? // "failure") | test("failure|failed|error|startup_failure"))
            | select(.head_branch | test("^(main|release/.+|hotfix/.+|develop)$"))
          ]
          ')
        [[ $(echo "$FAILURES" | jq 'length') -eq 0 ]] && exit 0

        # –§–æ—Ä–º–∏—Ä—É–µ–º –º–æ–Ω–æ–ª–∏—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        COUNT="$(jq 'length' <<< "$FAILURES")"
        HEADER="üïí 24h in ${{ github.repository }}: ‚ùå *${COUNT} FAILED*"
        
        # –î–µ–ª–∞–µ–º –∞–∫–∫—É—Ä–∞—Ç–Ω—É—é —Ç–∞–±–ª–∏—Ü—É —Å –ø—Ä–æ–±–µ–ª–∞–º–∏
        DETAILS=$(
          jq -r '
          map(
            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –∏–º–µ–Ω–∏. –ï—Å–ª–∏ –∏–º—è –¥–ª–∏–Ω–Ω–µ–µ 30 —Å–∏–º–≤–æ–ª–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º "..."
            # –ó–∞—Ç–µ–º –¥–æ–ø–æ–ª–Ω—è–µ–º –ø—Ä–æ–±–µ–ª–∞–º–∏ –¥–æ 30 —Å–∏–º–≤–æ–ª–æ–≤, —á—Ç–æ–±—ã –≤–µ—Ç–∫–∞ –Ω–∞—á–∏–Ω–∞–ª–∞—Å—å –≤ –æ–¥–Ω–æ–º —Å—Ç–æ–ª–±—Ü–µ
            .name as $name
            | ($name[:30] + if ($name|length) > 30 then "..." else "" end) as $trimName
            | $trimName + ( " " | ljust( (33 - ($trimName|length)); " " ) ) 
              + "| üìå " + .head_branch
              + " ‚Üí " + .html_url
          ) | join("\n")
          ' <<< "$FAILURES"
        )
        
        # –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤—Å—ë –≤ –±–ª–æ–∫ –∫–æ–¥–∞ —Å —Ç—Ä–æ–π–Ω—ã–º–∏ –±—ç–∫—Ç–∏–∫–∞–º–∏ –¥–ª—è –º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω–æ–≥–æ —à—Ä–∏—Ñ—Ç–∞
        MESSAGE="$(printf "%s\n\`\`\`\n%s\n\`\`\`" "$HEADER" "$DETAILS")"

        curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\", \"disable_web_page_preview\": true}"


