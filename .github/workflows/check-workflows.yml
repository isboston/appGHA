name: Check Workflows

on:
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:

jobs:
  check-failed-workflows:
    runs-on: ubuntu-latest
    steps:
      - name: Notify failed runs
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          FAILURES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" | 
            jq --arg start "$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ)" --arg cur "${{ github.run_id }}" '
            [ .workflow_runs[] | select(.created_at >= $start and .id != ($cur | tonumber)) 
              | select((.conclusion? // "failure") | test("failure|failed|error|startup_failure"))
              | select(.head_branch | test("^(main|release/.+|hotfix/.+|develop)$")) ]')

          [[ $(echo "$FAILURES" | jq 'length') -eq 0 ]] && exit 0

          MESSAGE="ğŸ•’ 24h in ${{ github.repository }}: âŒ *$(jq 'length' <<< "$FAILURES") FAILED*\n\n"

          while IFS= read -r line; do
            NAME=$(echo "$line" | jq -r '.name')
            URL=$(echo "$line" | jq -r '.html_url')
            BRANCH=$(echo "$line" | jq -r '.head_branch')

            if [[ ${#NAME} -gt 30 ]]; then
              NAME="${NAME:0:27}..."
            fi

            printf -v ENTRY "ğŸ”¹ [%-30s](%s) | ğŸ“Œ %-15s\n" "$NAME" "$URL" "$BRANCH"
            MESSAGE+="$ENTRY"
          done < <(echo "$FAILURES" | jq -c '.[]')

          echo -e "$MESSAGE"

          CLEAN_MESSAGE=$(echo "$MESSAGE" | jq -Rr @sh)

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": $CLEAN_MESSAGE, \"parse_mode\": \"Markdown\", \"disable_web_page_preview\": true}"
