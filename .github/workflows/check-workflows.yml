name: Check Workflows

on:
  schedule:
    - cron: "55 6 * * *"
  workflow_dispatch:

jobs:
  check-failed-workflows:
    runs-on: ubuntu-latest
    steps:
    - name: Notify failed runs
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        FAILURES=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" | 
          jq --arg start "$(date -u -d '24 hours ago' +%Y-%m-%dT%H:%M:%SZ)" --arg cur "${{ github.run_id }}" '
          [ .workflow_runs[]
            | select(.created_at >= $start and .id != ($cur | tonumber))
            | select((.conclusion? // "failure") | test("failure|failed|error|startup_failure"))
            | select(.head_branch | test("^(main|release/.+|hotfix/.+|develop)$"))
          ]
          ')
        [[ $(echo "$FAILURES" | jq 'length') -eq 0 ]] && exit 0

        COUNT="$(jq 'length' <<< "$FAILURES")"
        HEADER="ðŸ•’ 24h in ${{ github.repository }}: âŒ *${COUNT} FAILED*"

        # Ð“Ð¾Ñ‚Ð¾Ð²Ð¸Ð¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ Ñ Ð²Ñ‹Ñ€Ð°Ð²Ð½Ð¸Ð²Ð°Ð½Ð¸ÐµÐ¼
        DETAILS=$(
          jq -r '
          map(
            .name as $name
            | ($name[:30] + if ($name | length) > 30 then "..." else "" end) as $trimName
            | ($trimName | length) as $ln
            | (35 - $ln) as $spacesNeeded
            | (if $spacesNeeded < 0 then 0 else $spacesNeeded end) as $spaces
            | "[ðŸ”¹ " + $trimName + ("                                    ")[0:$spaces] + "](\(.html_url)) | ðŸ“Œ *" + .head_branch + "*"
          ) | join("\n")
          ' <<< "$FAILURES"
        )

        MESSAGE="$(printf "%s\n%s" "$HEADER" "$DETAILS")"

        curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -H "Content-Type: application/json" \
          -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\", \"disable_web_page_preview\": true}"


