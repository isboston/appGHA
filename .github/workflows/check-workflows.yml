name: Check Workflows

on:
  schedule:
    - cron: "0 7 * * *"
  workflow_dispatch:

jobs:
  check-workflows:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check and report workflows
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Set the time range for the last 24 hours
          START_TIME=$(date -u -d "24 hours ago" +"%Y-%m-%dT%H:%M:%SZ")
          END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          CURRENT_RUN_ID=${{ github.run_id }}

          # Fetch workflows, filter by time range and exclude the current run, then format the output
          OUTPUT=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" | \
            jq --arg start "$START_TIME" --arg end "$END_TIME" --arg current_run_id "$CURRENT_RUN_ID" '
              [.workflow_runs[]
                | select(.created_at >= $start and .created_at <= $end and (.id != ($current_run_id | tonumber)))
                | { name, branch: .head_branch, html_url, status: (.conclusion // "failure"), triggered_by: (.triggering_actor.login // "unknown"), created_at }
              ]
            ')

          TOTAL=$(echo "$OUTPUT" | jq 'length')
          [ "$TOTAL" -eq 0 ] && exit 0
          FAILURES=$(echo "$OUTPUT" | jq '[.[] | select(.status == "failure" or .status == "failed" or .status == "error" or .status == "startup_failure")]')
          FAIL_COUNT=$(echo "$FAILURES" | jq 'length')
          [ "$FAIL_COUNT" -eq 0 ] && exit 0

          MESSAGE="ðŸ•’ Last 24h | ðŸ“Š Workflows: $TOTAL | âŒ *Failed: $FAIL_COUNT*\n"
          FAIL_LIST=$(echo "$FAILURES" | jq -r 'map("ðŸ”¹ [\(.name | if length > 25 then .[0:25] + \"...\" else . end)](\(.html_url)) | ðŸ“Œ \(.branch)") | join("\n")')
          MESSAGE+="$FAIL_LIST"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\", \"disable_web_page_preview\": true}"

