name: Check Workflows

on:
  schedule:
    - cron: "5 0 * * *"  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:05 UTC
  workflow_dispatch:

jobs:
  check-build-results:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ workflow runs –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
        run: |
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–∏–æ–¥: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞
          START_TIME=$(date -u -d "24 hours ago" +"%Y-%m-%dT%H:%M:%SZ")
          END_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º workflow runs —Å $START_TIME –ø–æ $END_TIME"

          # –ó–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 100 –∑–∞–ø—É—Å–∫–æ–≤ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å)
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=100" | \
            jq --arg start "$START_TIME" --arg end "$END_TIME" \
            '[.workflow_runs[] | select(.created_at >= $start and .created_at <= $end)]' > workflow_runs.json

          echo "–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:"
          cat workflow_runs.json

          # –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ JSON —Å –Ω—É–∂–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π —Å—Ç–∞—Ç—É—Å–∞ (–µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, —Å—á–∏—Ç–∞–µ–º –∑–∞ –Ω–µ—É–¥–∞—á–Ω—ã–π)
          jq '[.[] | {name: .name, branch: .head_branch, html_url: .html_url, status: (.conclusion // "failure"), triggered_by: (.triggering_actor.login // "unknown")}]' workflow_runs.json > merged_results.json
          echo "–ò—Ç–æ–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:"
          cat merged_results.json

      - name: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—á—ë—Ç –≤ Telegram, –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -s merged_results.json ] || [ "$(jq 'length' merged_results.json)" -eq 0 ]; then
            echo "–ó–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –Ω–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —Å–±–æ—Ä–æ–∫."
            exit 0
          fi

          TOTAL=$(jq 'length' merged_results.json)

          LAST_RUN_ID=$(jq '.[0].id' merged_results.json)
          echo "ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–∫—à–µ–Ω–∞: $LAST_RUN_ID"

           # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ —ç–∫—à–µ–Ω—ã (–Ω–µ "queued" –∏ –Ω–µ "in_progress")
          FILTERED_RESULTS=$(jq '[.[] | select(.status != "queued" and .status != "in_progress")]' merged_results.json)

          # –ò—Å–∫–ª—é—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç–∫—à–µ–Ω (–∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–µ–π—á–∞—Å)
          FILTERED_RESULTS=$(echo "$FILTERED_RESULTS" | jq '[.[] | select(.id != '"$LAST_RUN_ID"')]')

          # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–µ—É–¥–∞—á–Ω—ã–µ —Å–±–æ—Ä–∫–∏

          FAILURES=$(echo "$FILTERED_RESULTS" | jq '[.[] | select((.status == "failure" or .status == "failed" or .status == "error" or .status == "startup_failure") and .status != "in_progress")]')
          echo "$FAILURES"
          FAIL_COUNT=$(echo "$FAILURES" | jq 'length')
          MESSAGE="üïí *–û—Ç—á—ë—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞*\n"
          MESSAGE+="üìä –í—Å–µ–≥–æ —Å–±–æ—Ä–æ–∫: *$TOTAL*\n"

          if [ "$FAIL_COUNT" -eq 0 ]; then
            echo "–í—Å–µ —Å–±–æ—Ä–∫–∏ —É—Å–ø–µ—à–Ω—ã. –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞."
            exit 0  # –ï—Å–ª–∏ –Ω–µ—Ç –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Å–±–æ—Ä–æ–∫, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          else
            MESSAGE+="‚ùå *–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–±–æ—Ä–∫–∏: $FAIL_COUNT*\n\n"
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –æ—à–∏–±–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ workflow
            FAIL_LIST=$(echo "$FAILURES" | jq -r $'
              map(
                "üîπ *\(.name // \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π workflow\")* " +
                "\n  ‚îú üìå –í–µ—Ç–∫–∞: *\(.branch // \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –≤–µ—Ç–∫–∞\")*" +
                "\n  ‚îú üë§ –ó–∞–ø—É—Å—Ç–∏–ª: *\(.triggered_by // \"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π\")*" +
                "\n  ‚îú üîó [–õ–æ–≥](\(.html_url // \"–ù–µ—Ç —Å—Å—ã–ª–∫–∏\"))\n"
              ) | join("\n")
            ')
            MESSAGE+="$FAIL_LIST"
          fi

          # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\", \"disable_web_page_preview\": true}"
