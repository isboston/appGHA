name: Daily Build Report

on:
  schedule:
    - cron: "*/10 * * * *"  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç (–¥–ª—è —Ç–µ—Å—Ç–∞)
  workflow_dispatch:  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  check-build-results:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all build results
        uses: actions/download-artifact@v4
        with:
          path: all_results
        continue-on-error: true

      - name: –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ build_results –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª
        run: |
          echo "[]" > merged_results.json
          find all_results -name "build_results-*/build_results.json" | while read file; do
            if [ -f "$file" ]; then
              jq -s 'add' merged_results.json "$file" > tmp.json && mv tmp.json merged_results.json
            fi
          done

      - name: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–±–æ—Ä–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -f merged_results.json ]; then
            echo "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–±–æ—Ä–∫–∞—Ö. –í—ã—Ö–æ–¥."
            exit 0
          fi

          FAILURES=$(jq '[.[] | select(.status=="failure")] | length' merged_results.json)
          TOTAL=$(jq 'length' merged_results.json)

          if [ "$FAILURES" -eq 0 ]; then
            echo "–í—Å–µ —Å–±–æ—Ä–∫–∏ —É—Å–ø–µ—à–Ω—ã. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è."
            exit 0
          fi

          MESSAGE="üìÖ *–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Å–±–æ—Ä–∫–∞—Ö*\n"
          MESSAGE+="üìä –í—Å–µ–≥–æ —Å–±–æ—Ä–æ–∫: *$TOTAL*\n"
          MESSAGE+="‚ùå *–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–±–æ—Ä–∫–∏: $FAILURES*\n"
          MESSAGE+="üîó [–ü–µ—Ä–µ–π—Ç–∏ –∫ Actions](https://github.com/${{ github.repository }}/actions)\n"

          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"${{ secrets.TELEGRAM_CHAT_ID }}\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\"}"

      - name: –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –¥–Ω–µ–º
        run: rm -f merged_results.json

