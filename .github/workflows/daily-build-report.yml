name: Daily Build Report

on:
  schedule:
    - cron: "59 23 * * *"  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 23:59 UTC
  workflow_dispatch:  # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  check-build-results:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build results
        uses: actions/download-artifact@v4
        with:
          name: build_results
        continue-on-error: true  # –§–∞–π–ª –º–æ–∂–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å

      - name: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–±–æ—Ä–æ–∫ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -f build_results.json ]; then
            echo "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–±–æ—Ä–∫–∞—Ö. –í—ã—Ö–æ–¥."
            exit 0
          fi

          # –ü–æ–¥—Å—á–µ—Ç –ø—Ä–æ–≤–∞–ª–æ–≤
          FAILURES=$(jq '[.[] | select(.status=="failure")] | length' build_results.json)

          # –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç - –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          if [ "$FAILURES" -eq 0 ]; then
            echo "–í—Å–µ —Å–±–æ—Ä–∫–∏ —É—Å–ø–µ—à–Ω—ã. –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è."
            exit 0
          fi

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
          TOTAL=$(jq 'length' build_results.json)
          MESSAGE="üìÖ *–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á–µ—Ç –æ —Å–±–æ—Ä–∫–∞—Ö*\n"
          MESSAGE+="üìä –í—Å–µ–≥–æ —Å–±–æ—Ä–æ–∫: *$TOTAL*\n"
          MESSAGE+="‚ùå *–ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–±–æ—Ä–∫–∏: $FAILURES*\n"
          MESSAGE+="üîó [–ü–µ—Ä–µ–π—Ç–∏ –∫ Actions](https://github.com/${{ github.repository }}/actions)\n"

          curl -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -H "Content-Type: application/json" \
            -d "{\"chat_id\": \"$TELEGRAM_CHAT_ID\", \"text\": \"$MESSAGE\", \"parse_mode\": \"Markdown\"}"

      - name: –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –¥–Ω–µ–º
        run: rm -f build_results.json
